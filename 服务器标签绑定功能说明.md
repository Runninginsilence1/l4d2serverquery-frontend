# 服务器列表功能说明

## 功能概述

在服务器列表（TableView）中包含以下主要功能：
1. **标签绑定功能**：允许用户为每个服务器绑定多个标签，方便管理和分类服务器
2. **玩家数量过滤**：支持按在线玩家数量范围筛选服务器
3. **本地搜索功能**：支持在已有结果中进行前端搜索，无需重复调用后端接口

## 前端实现

### 功能一：标签绑定

1. **标签列显示**
   - 在服务器列表中新增"标签"列
   - 显示该服务器已绑定的所有标签
   - 如果没有标签，显示"暂无标签"

2. **标签按钮**
   - 在操作列新增"标签"按钮（黄色warning样式）
   - 点击打开标签绑定对话框

3. **标签绑定对话框**
   - 显示所有可用的标签
   - 支持多选（复选框样式）
   - 自动勾选该服务器已绑定的标签
   - 点击"保存绑定"后更新绑定关系

### 功能二：玩家数量过滤

1. **玩家数量筛选器**
   - 在搜索栏中新增"在线玩家数"筛选器
   - 包含两个数字输入框：最小玩家数和最大玩家数
   - 输入范围：0-32
   - 支持单独设置最小值或最大值，也支持同时设置范围

2. **筛选逻辑**
   - 只设置最小值：查询在线玩家数 >= 最小值的服务器
   - 只设置最大值：查询在线玩家数 <= 最大值的服务器
   - 同时设置：查询在线玩家数在该范围内的服务器
   - 都为0或不设置：不进行玩家数量过滤

3. **重置按钮**
   - 新增"重置"按钮，一键清空所有筛选条件
   - 包括：搜索关键字、最小玩家数、最大玩家数

### 功能三：本地搜索

1. **本地搜索复选框**
   - 在搜索栏中新增"本地搜索"复选框
   - 勾选后，搜索将在前端已有的结果中进行，不调用后端接口
   - 未勾选时，保持原有行为（调用后端接口）

2. **搜索逻辑**
   - **后端搜索（默认）**：调用 `/serverList/v2` 接口，从后端获取数据
   - **本地搜索**：在前端缓存的 `originalServerList` 中过滤数据
   - 本地搜索支持：
     - 按服务器名称过滤（模糊匹配）
     - 按服务器地址过滤（模糊匹配）
     - 按玩家数量范围过滤
   - **不支持递归搜索**：每次搜索都基于原始数据，不会在上次搜索结果上继续搜索

3. **工作原理**
   - 首次后端查询时，自动保存结果到 `originalServerList`
   - 勾选"本地搜索"后，所有筛选操作都在 `originalServerList` 上进行
   - 取消勾选后，恢复后端查询模式

4. **用户体验优化**
   - 按钮文字动态变化：未勾选显示"查询服务器"，勾选后显示"搜索"
   - 如果没有原始数据就进行本地搜索，会提示"请先进行后端查询以获取数据"
   - 搜索完成后显示找到的服务器数量

### 文件修改

#### 1. `/src/api/tag.js`
新增三个API函数：
- `bindTagsToServer(serverId, tagIds)` - 绑定标签到服务器
- `getServerTags(serverId)` - 获取服务器的标签
- `unbindTagFromServer(serverId, tagId)` - 解绑单个标签

#### 2. `/src/views/TableView.vue`
主要修改：

**状态变量**：
- `minPlayers` - 最小在线玩家数
- `maxPlayers` - 最大在线玩家数
- `useLocalSearch` - 是否使用本地搜索
- `originalServerList` - 保存原始服务器列表，用于本地搜索
- `bindTagDialogVisible` - 控制标签对话框显示
- `allTags` - 所有可用标签
- `selectedTags` - 当前选中的标签
- `currentServerId` - 当前操作的服务器ID
- `currentServerName` - 当前操作的服务器名称

**新增函数**：
- `localSearchFunc()` - 执行本地搜索和过滤
- `openBindTagDialog()` - 打开绑定标签对话框
- `saveTagBinding()` - 保存标签绑定
- `resetFilters()` - 重置所有筛选条件（包括本地搜索状态）

**修改函数**：
- `queryServerFuncV2()` - 支持玩家数量过滤和本地搜索切换

**UI改动**：
- 搜索区域新增玩家数量筛选器（两个数字输入框）
- 搜索区域新增"本地搜索"复选框
- 查询按钮文字动态显示："查询服务器" / "搜索"
- 新增"重置"按钮
- 新增"标签"列显示服务器标签
- 操作列宽度从320调整为400
- 新增"标签"按钮
- 新增标签绑定对话框

## 使用流程

### 后端搜索流程（默认）

1. 用户输入搜索条件（服务器名称、玩家数量等）
2. **确保"本地搜索"复选框未勾选**
3. 点击"查询服务器"按钮
4. 系统调用 `/serverList/v2` 接口，传递参数
5. 后端返回符合条件的服务器列表
6. 前端显示结果，并**自动保存到本地缓存**供后续本地搜索使用

### 本地搜索流程

1. **前提**：必须先执行一次后端查询，获取基础数据
2. **勾选"本地搜索"复选框**
3. 输入或修改搜索条件（服务器名称、玩家数量等）
4. 点击"搜索"按钮
5. 系统在本地缓存的数据中进行过滤（**不调用后端接口**）
6. 前端立即显示筛选结果
7. 显示消息：`本地搜索完成，找到 X 个服务器`

### 搜索模式切换

- **切换到本地搜索**：勾选"本地搜索"复选框
- **切换回后端搜索**：取消勾选"本地搜索"复选框
- **重置所有设置**：点击"重置"按钮，会自动取消本地搜索并恢复原始列表

### 标签绑定流程

1. 用户点击服务器列表中的"标签"按钮
2. 系统打开对话框，加载所有可用标签和该服务器已绑定的标签
3. 用户勾选/取消勾选标签（支持多选）
4. 用户点击"保存绑定"按钮
5. 系统调用后端API保存绑定关系
6. 绑定成功后关闭对话框并刷新服务器列表
7. 服务器列表的"标签"列显示更新后的标签

### 数据流

#### 后端搜索数据流
```
用户输入搜索条件（未勾选"本地搜索"）
    ↓
点击"查询服务器"
    ↓
构建请求参数 {
  name: "搜索关键字",
  tags: [标签ID数组],
  minPlayers: 2,  // 可选
  maxPlayers: 6   // 可选
}
    ↓
调用 POST /serverList/v2
    ↓
后端过滤符合条件的服务器
    ↓
返回服务器列表（包含 tags 字段）
    ↓
保存到 originalServerList（本地缓存）
    ↓
前端显示筛选结果
```

#### 本地搜索数据流
```
用户勾选"本地搜索"复选框
    ↓
输入搜索条件
    ↓
点击"搜索"按钮
    ↓
检查 originalServerList 是否有数据
    ↓
如果没有数据 → 提示"请先进行后端查询以获取数据"
    ↓
如果有数据 → 从 originalServerList 复制数据
    ↓
按服务器名称/地址过滤（模糊匹配）
    ↓
按玩家数量范围过滤
    ↓
更新显示列表
    ↓
显示消息："本地搜索完成，找到 X 个服务器"
```

#### 标签绑定数据流
```
用户点击"标签"按钮
    ↓
调用 getAllTags() 获取所有标签
    ↓
调用 getServerTags(serverId) 获取服务器当前标签
    ↓
显示对话框，勾选已绑定的标签
    ↓
用户修改选择
    ↓
点击"保存绑定"
    ↓
调用 bindTagsToServer(serverId, selectedTagIds)
    ↓
绑定成功，刷新服务器列表 queryServerFuncV2()
    ↓
服务器列表显示更新后的标签（从后端返回的 tags 字段）
```

## 界面说明

### 搜索区域
- **搜索框**：输入服务器名称关键字
- **在线玩家数筛选器**：
  - 标签文字"在线玩家数："
  - 最小玩家数输入框（0-32）
  - 分隔符"-"
  - 最大玩家数输入框（0-32）
- **本地搜索复选框**：勾选后启用前端搜索模式
- **查询/搜索按钮**：
  - 未勾选本地搜索：显示"查询服务器"
  - 勾选本地搜索：显示"搜索"
- **重置按钮**：清空所有筛选条件（包括取消本地搜索）

### 服务器列表
- 新增"标签"列，位于"玩家数量"和"最后复制时间"之间
- 标签以Element Plus的`el-tag`组件展示
- 多个标签横向排列，自动换行

### 操作列
- 复制按钮（蓝色）
- 玩家按钮（灰色）
- **标签按钮（黄色）** - 新增
- 刷新按钮（绿色）
- 删除按钮（红色）

### 标签绑定对话框
- 对话框标题显示：🏷️ 绑定标签 - [服务器名称]
- 顶部有提示信息
- 标签以带边框的复选框形式展示，每行一个
- 底部有"取消"和"保存绑定"按钮

## 后端要求

详细的后端API设计请参考 `后端API参考-服务器标签绑定.md`

### 关键点

1. **修改 `/serverList/v2` 接口（已完成）**
   - 支持 `minPlayers` 和 `maxPlayers` 参数
   - 在返回的服务器对象中包含 `tags` 字段
   - 请求体示例：
   ```json
   {
     "name": "服务器名称",
     "tags": [1, 2],
     "minPlayers": 2,
     "maxPlayers": 6
   }
   ```
   - 响应示例：
   ```json
   [
     {
       "id": 24,
       "address": "106.54.61.52:25444",
       "serverName": "示例服务器",
       "onlinePlayers": 4,
       "maxPlayers": 8,
       "tags": [
         { "id": 1, "name": "高质量" },
         { "id": 2, "name": "活跃社区" }
       ]
     }
   ]
   ```

2. **实现标签绑定接口**
   - `POST /server/{serverId}/tags` - 绑定标签（传标签ID数组）
   - `GET /server/{serverId}/tags` - 获取服务器标签

3. **数据库设计**
   - 建议创建 `server_tag` 关联表
   - 添加唯一索引防止重复绑定

## 技术细节

### 前端技术栈
- Vue 3 Composition API
- Element Plus UI组件库
- TypeScript
- Axios (通过封装的 myrequest)

### 样式说明
- 标签按钮使用 `warning` 类型（黄色）
- 对话框宽度：600px
- 复选框使用 `border` 和 `size="large"` 样式
- 标签单元格使用 flexbox 布局，支持换行

### 错误处理
- 所有API调用都有 try-catch 错误处理
- 失败时显示 Element Plus 的错误消息
- 控制台输出详细错误信息便于调试

## 扩展建议

### 可能的优化方向

1. **批量绑定**
   - 支持选择多个服务器，批量绑定相同的标签

2. **标签过滤**
   - 在服务器列表顶部添加标签过滤器
   - 点击标签快速筛选对应的服务器

3. **标签统计**
   - 显示每个标签绑定了多少个服务器

4. **标签颜色**
   - 为不同标签设置不同的颜色
   - 在列表中以不同颜色展示

5. **快捷操作**
   - 在标签列直接点击标签快速解绑
   - 右键菜单快速绑定常用标签

## 使用示例

### 示例1：后端查询在线玩家数在2-6人的服务器
1. **确保"本地搜索"未勾选**
2. 在"最小"输入框输入：2
3. 在"最大"输入框输入：6
4. 点击"查询服务器"
5. 结果：从后端获取并显示所有在线玩家数在2-6人之间的服务器

### 示例2：本地搜索包含"asia"关键字的服务器
1. 先执行一次后端查询（获取所有服务器）
2. **勾选"本地搜索"复选框**
3. 在搜索框输入：asia
4. 点击"搜索"按钮
5. 结果：立即显示本地缓存中包含"asia"的服务器（服务器名称或地址）

### 示例3：本地搜索至少有4人在线的服务器
1. **前提**：已有后端查询的数据
2. **勾选"本地搜索"复选框**
3. 在"最小"输入框输入：4
4. 点击"搜索"按钮
5. 结果：立即从本地数据中筛选出在线玩家数≥4的服务器

### 示例4：组合条件的本地搜索
1. **前提**：已有后端查询的数据
2. **勾选"本地搜索"复选框**
3. 搜索框输入：某个关键字
4. 设置最小玩家数：2
5. 设置最大玩家数：8
6. 点击"搜索"按钮
7. 结果：立即显示同时符合所有条件的服务器

### 示例5：在后端搜索和本地搜索之间切换
1. 首次点击"查询服务器"（后端查询，获取100个服务器）
2. 勾选"本地搜索"
3. 搜索框输入：test（本地搜索，找到10个服务器）
4. 取消勾选"本地搜索"
5. 修改搜索条件，点击"查询服务器"（再次后端查询）
6. 结果：执行新的后端查询，获取新的数据集

### 示例6：重置所有筛选
1. 点击"重置"按钮
2. 所有筛选条件清空：
   - 搜索关键字清空
   - 最小玩家数重置为0
   - 最大玩家数重置为0
   - **"本地搜索"复选框取消勾选**
   - 如果有本地缓存数据，恢复显示完整列表

## 常见问题

### Q: 什么时候应该使用本地搜索？
A: 
- 当您已经获取了一批服务器数据，想要在其中快速筛选时
- 想要节省后端请求次数时
- 需要频繁调整搜索条件查看不同结果时

### Q: 本地搜索和后端搜索有什么区别？
A: 
- **后端搜索**：从数据库查询，支持标签过滤，可以获取完整的、最新的数据
- **本地搜索**：在前端已有数据中过滤，速度快，不调用接口，但只能搜索已加载的数据
- **标签过滤**：本地搜索不支持标签过滤（因为标签需要后端查询），只支持名称、地址和玩家数量过滤

### Q: 为什么本地搜索提示"请先进行后端查询以获取数据"？
A: 本地搜索需要基于已有数据进行过滤。如果还没有执行过后端查询，本地缓存是空的，需要先进行一次后端查询。

### Q: 本地搜索会在上次搜索结果上继续搜索吗（递归搜索）？
A: **不会**。每次本地搜索都是基于原始的 `originalServerList` 进行过滤，不会在上次搜索结果上继续搜索。例如：
- 第一次搜索："asia" → 找到50个服务器
- 第二次搜索："test" → 不是从这50个中搜索，而是从原始的全部数据中搜索

### Q: 切换搜索模式会丢失数据吗？
A: 不会。原始数据会一直保存在 `originalServerList` 中，直到执行新的后端查询。

### Q: 玩家数量设置为0是什么意思？
A: 设置为0表示不对该项进行过滤。例如，最小值为0表示不限制最小值。

### Q: 可以只设置最小值或只设置最大值吗？
A: 可以。只设置最小值会返回玩家数≥该值的服务器；只设置最大值会返回玩家数≤该值的服务器。

### Q: 为什么绑定后看不到标签？
A: 请确保后端的 `/serverList/v2` 接口返回了 `tags` 字段。

### Q: 绑定标签失败怎么办？
A: 检查控制台错误信息，确认：
- 后端API是否正确实现
- 服务器ID和标签ID是否有效
- 是否有权限执行操作

### Q: 如何创建新标签？
A: 通过导航菜单进入"标签管理"页面，可以创建和管理标签。

### Q: 可以清空服务器的所有标签吗？
A: 可以，在标签绑定对话框中取消所有标签的勾选，点击保存即可。

### Q: 玩家数量筛选对后端性能有影响吗？
A: 筛选是在数据库层面进行的，性能影响很小。建议后端在 `onlinePlayers` 字段上建立索引以优化查询性能。

### Q: 本地搜索的性能如何？
A: 本地搜索在前端内存中进行，性能非常好。即使有数千条服务器记录，过滤操作也能在毫秒级完成。

## 最佳实践

1. **首次使用**：先进行后端查询，获取完整的服务器列表
2. **快速筛选**：使用本地搜索在已有数据中快速查找
3. **更新数据**：取消本地搜索，执行后端查询获取最新数据
4. **频繁操作**：在调整筛选条件时使用本地搜索，减少后端压力
5. **标签筛选**：标签筛选需要后端支持，务必取消本地搜索模式
